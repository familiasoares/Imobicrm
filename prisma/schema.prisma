// =============================================================================
// schema.prisma — Wave CRM (Completo e Auditável)
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---

enum UserRole {
  ADMIN_SAAS
  GERENTE
  CORRETOR
}

enum LeadStatus {
  NOVO_LEAD
  EM_ATENDIMENTO
  VISITA
  AGENDAMENTO
  PROPOSTA
  VENDA_FECHADA
  VENDA_PERDIDA
}

enum SubscriptionStatus {
  ATIVA
  ATRASADA
  BLOQUEADA
}

// --- MODELS ---

model Tenant {
  id           String         @id @default(cuid())
  nome         String
  cnpj         String?        @unique
  criadoEm     DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  users        User[]
  leads        Lead[]
  tasks        Task[]
  subscription Subscription?

  @@map("tenants")
}

model Subscription {
  id                  String             @id @default(cuid())
  tenantId            String             @unique
  status              SubscriptionStatus @default(ATIVA)
  dataVencimento      DateTime
  linkPagamento       String?
  asaasCustomerId     String?
  asaasSubscriptionId String?
  criadoEm            DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  tenant              Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model User {
  id        String    @id @default(cuid())
  tenantId  String?
  nome      String
  email     String    @unique
  senha     String
  role      UserRole  @default(CORRETOR)
  ativo     Boolean   @default(true)
  criadoEm  DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  tenant    Tenant?   @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  leads     Lead[]
  
  // Relação para auditoria do histórico
  history   LeadHistory[]

  @@index([tenantId])
  @@map("users")
}

model Lead {
  id           String     @id @default(cuid())
  tenantId     String
  userId       String?
  nome         String
  telefone     String
  ddd          String
  cidade       String
  interesse    String

  // Campos de Perfil (Evolução Wave CRM)
  tipoImovel               String?   
  valorPretendido          String?   
  perfilFinanceiro         String?   
  caracteristicasDesejadas String?   

  observacoes  String?    @db.Text
  status       LeadStatus @default(NOVO_LEAD)
  isArquivado  Boolean    @default(false)
  criadoEm     DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  corretor     User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  lossReasons  LossReason[]
  history      LeadHistory[]
  tasks        Task[]

  @@index([tenantId])
  @@index([userId])
  @@index([status])
  @@index([tenantId, isArquivado])
  @@map("leads")
}

model LossReason {
  id       String   @id @default(cuid())
  leadId   String
  motivo   String
  criadoEm DateTime @default(now())
  lead     Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@map("loss_reasons")
}

model LeadHistory {
  id           String     @id @default(cuid())
  leadId       String
  userId       String?    // ID do usuário que realizou a ação
  statusAntes  LeadStatus
  statusDepois LeadStatus
  observacao   String?    @db.Text
  criadoEm     DateTime   @default(now())
  
  lead         Lead       @relation(fields: [leadId], references: [id], onDelete: Cascade)
  usuario      User?      @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([leadId])
  @@index([userId])
  @@map("lead_history")
}

model Task {
  id           String   @id @default(cuid())
  tenantId     String
  leadId       String
  titulo       String
  tipo         String
  dataAgendada DateTime
  concluida    Boolean  @default(false)
  prioridade   Int      @default(1)
  criadoEm     DateTime @default(now())
  updatedAt    DateTime @updatedAt
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lead         Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([tenantId, dataAgendada])
  @@map("tasks")
}