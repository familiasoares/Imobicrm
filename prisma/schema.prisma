// =============================================================================
// schema.prisma
// CRM SaaS Multi-Tenant ‚Äî Gest√£o de Leads Imobili√°rios
// =============================================================================
// Conven√ß√µes:
//  ‚Ä¢ Todos os modelos principais possuem tenantId para isolamento total de dados
//    por imobili√°ria (tenant). Isto garante que nenhum tenant veja dados de outro.
//  ‚Ä¢ Datas s√£o armazenadas em UTC (DateTime @default(now()) / @updatedAt).
//  ‚Ä¢ Soft-delete via campo isArquivado (sem remo√ß√£o f√≠sica de registos).
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// ENUMS
// =============================================================================

/// Papel (role) do utilizador dentro do sistema.
enum UserRole {
  ADMIN_SAAS
  GERENTE
  CORRETOR
}

/// Est√°gios do funil de vendas de um lead imobili√°rio.
enum LeadStatus {
  NOVO_LEAD
  EM_ATENDIMENTO
  VISITA
  AGENDAMENTO
  PROPOSTA
  VENDA_FECHADA
  VENDA_PERDIDA
}

/// Estado da assinatura/pagamento do tenant junto ao SaaS.
enum SubscriptionStatus {
  ATIVA
  ATRASADA
  BLOQUEADA
}

// =============================================================================
// MODELO: Tenant (Imobili√°ria / Cliente do SaaS)
// =============================================================================

model Tenant {
  id        String   @id @default(cuid())
  nome      String   // Nome fantasia da imobili√°ria
  cnpj      String?  @unique // CNPJ (opcional, para fatura√ß√£o)
  criadoEm  DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos (1-N)
  users        User[]
  leads        Lead[]
  tasks        Task[]             // üëà NOVA RELA√á√ÉO: O Tenant possui v√°rias tarefas
  subscription Subscription?      // (1-1) cada tenant tem no m√°ximo 1 assinatura

  @@map("tenants")
}

// =============================================================================
// MODELO: Subscription (Assinatura do Tenant)
// =============================================================================

model Subscription {
  id                  String             @id @default(cuid())
  tenantId            String             @unique // FK ‚Üí Tenant (1-1)
  status              SubscriptionStatus @default(ATIVA)
  dataVencimento      DateTime           // Pr√≥xima data de cobran√ßa/vencimento
  linkPagamento       String?            // URL de boleto/Pix gerado pelo Asaas
  asaasCustomerId     String?            // ID do cliente no Asaas (integra√ß√£o externa)
  asaasSubscriptionId String?            // ID da assinatura no Asaas
  criadoEm            DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  // Relacionamento (N-1)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

// =============================================================================
// MODELO: User (Utilizador)
// =============================================================================

model User {
  id        String   @id @default(cuid())
  tenantId  String?  // NULL apenas para ADMIN_SAAS
  nome      String
  email     String   @unique
  senha     String   // Hash bcrypt ‚Äî nunca armazenar em texto simples
  role      UserRole @default(CORRETOR)
  ativo     Boolean  @default(true) // Permite desativar conta sem apagar
  criadoEm  DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamento N-1 com Tenant
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  // Relacionamento 1-N com Lead (leads sob responsabilidade deste corretor)
  leads Lead[]

  @@index([tenantId])
  @@map("users")
}

// =============================================================================
// MODELO: Lead (Entidade Principal)
// =============================================================================

model Lead {
  id          String     @id @default(cuid())
  tenantId    String     // FK ‚Üí Tenant (isolamento multi-tenant)
  userId      String?    // FK ‚Üí User (corretor respons√°vel; nullable = sem respons√°vel)
  nome        String
  telefone    String
  ddd         String     // Ex.: "11", "21", "47" (max 3 chars)
  cidade      String
  interesse   String
  observacoes String?    @db.Text
  status      LeadStatus @default(NOVO_LEAD)
  isArquivado Boolean    @default(false) // Soft-delete: true = lead arquivado/descartado
  criadoEm    DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relacionamento N-1 com Tenant
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Relacionamento N-1 com User (corretor respons√°vel)
  corretor User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Relacionamento 1-N com LossReason (apenas quando status = VENDA_PERDIDA)
  lossReasons LossReason[]

  // Relacionamento 1-N com LeadHistory (auditoria de mudan√ßas de status)
  history LeadHistory[]

  // Relacionamento 1-N com Task (Tarefas e Lembretes agendados para este lead)
  tasks Task[] // üëà NOVA RELA√á√ÉO: O Lead possui v√°rias tarefas

  @@index([tenantId])
  @@index([userId])
  @@index([status])
  @@index([tenantId, isArquivado]) // √çndice composto para queries de listagem filtrada
  @@map("leads")
}

// =============================================================================
// MODELO: LossReason (Motivo de Perda)
// =============================================================================

model LossReason {
  id       String   @id @default(cuid())
  leadId   String   // FK ‚Üí Lead
  motivo   String   // Texto livre: ex. "Pre√ßo acima do or√ßamento"
  criadoEm DateTime @default(now())

  // Relacionamento N-1 com Lead
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@map("loss_reasons")
}

// =============================================================================
// MODELO: LeadHistory (Hist√≥rico / Auditoria de Status)
// =============================================================================

model LeadHistory {
  id           String     @id @default(cuid())
  leadId       String     // FK ‚Üí Lead
  statusAntes  LeadStatus // Status anterior √† mudan√ßa
  statusDepois LeadStatus // Novo status ap√≥s a mudan√ßa
  observacao   String?    // Nota opcional do corretor sobre a transi√ß√£o
  criadoEm     DateTime   @default(now())

  // Relacionamento N-1 com Lead
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@map("lead_history")
}

// =============================================================================
// MODELO: Task (Automa√ß√£o / Agenda / Follow-up)
// =============================================================================

/// Representa uma tarefa ou a√ß√£o agendada pelo corretor para um lead espec√≠fico.
/// Pode ser criada manualmente ou gerada automaticamente pela IA ao ler as notas.
model Task {
  id           String   @id @default(cuid())
  tenantId     String   // FK ‚Üí Tenant (Isolamento de dados)
  leadId       String   // FK ‚Üí Lead (Cliente alvo da tarefa)
  
  titulo       String   // Resumo da a√ß√£o (Ex: "Enviar Op√ß√µes de Im√≥veis")
  tipo         String   // LIGAR, VISITA, ENVIAR_IMOVEIS, REUNIAO, PROPOSTA, ESCRITURA, RETORNAR
  
  dataAgendada DateTime // Quando a tarefa deve ser executada
  concluida    Boolean  @default(false) // false = Pendente, true = Feita
  prioridade   Int      @default(1) // 1: Normal, 2: Alta, 3: Urgente
  
  criadoEm     DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relacionamentos N-1
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lead         Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  // √çndices para garantir que a Agenda carregue r√°pido
  @@index([leadId])
  @@index([tenantId, dataAgendada])
  @@map("tasks")
}