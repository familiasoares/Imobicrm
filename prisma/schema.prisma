// =============================================================================
// schema.prisma
// CRM SaaS Multi-Tenant ‚Äî Gest√£o de Leads Imobili√°rios
// =============================================================================
// Conven√ß√µes:
//  ‚Ä¢ Todos os modelos principais possuem tenantId para isolamento total de dados
//    por imobili√°ria (tenant). Isto garante que nenhum tenant veja dados de outro.
//  ‚Ä¢ Datas s√£o armazenadas em UTC (DateTime @default(now()) / @updatedAt).
//  ‚Ä¢ Soft-delete via campo isArquivado (sem remo√ß√£o f√≠sica de registos).
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// ENUMS
// =============================================================================

/// Papel (role) do utilizador dentro do sistema.
/// ADMIN_SAAS  ‚Üí dono/operador da plataforma (acesso global).
/// GERENTE     ‚Üí dono ou gestor de uma imobili√°ria espec√≠fica (acesso ao seu tenant).
/// CORRETOR    ‚Üí agente comercial respons√°vel por leads (acesso aos seus pr√≥prios leads).
enum UserRole {
  ADMIN_SAAS
  GERENTE
  CORRETOR
}

/// Est√°gios do funil de vendas de um lead imobili√°rio.
/// A progress√£o tipicamente segue esta ordem, mas pode retroceder ou
/// saltar directamente para VENDA_FECHADA ou VENDA_PERDIDA.
enum LeadStatus {
  NOVO_LEAD        // Lead rec√©m-captado, ainda n√£o atendido
  EM_ATENDIMENTO   // Corretor j√° contactou o lead / est√° em negocia√ß√£o
  VISITA           // Visita ao im√≥vel agendada ou realizada
  AGENDAMENTO      // Agendamento formal de reuni√£o / assinatura
  PROPOSTA         // Proposta comercial enviada ao lead
  VENDA_FECHADA    // Neg√≥cio conclu√≠do com sucesso
  VENDA_PERDIDA    // Lead descartado ‚Äî motivo registado em LossReason
}

/// Estado da assinatura/pagamento do tenant junto ao SaaS.
/// ATIVA    ‚Üí pagamento em dia, acesso total.
/// ATRASADA ‚Üí pagamento vencido mas ainda com acesso (per√≠odo de gra√ßa).
/// BLOQUEADA‚Üí acesso suspenso por inadimpl√™ncia prolongada.
enum SubscriptionStatus {
  ATIVA
  ATRASADA
  BLOQUEADA
}

// =============================================================================
// MODELO: Tenant (Imobili√°ria / Cliente do SaaS)
// =============================================================================

/// Representa cada imobili√°ria cliente do SaaS.
/// √â o ponto-raiz de toda a hierarquia multi-tenant.
/// Relacionamentos:
///   1-para-N com User        (uma imobili√°ria tem v√°rios utilizadores)
///   1-para-N com Lead        (uma imobili√°ria tem v√°rios leads)
///   1-para-1 com Subscription(cada imobili√°ria tem uma assinatura)
model Tenant {
  id        String   @id @default(cuid())
  nome      String                              // Nome fantasia da imobili√°ria
  cnpj      String?  @unique                    // CNPJ (opcional, para fatura√ß√£o)
  criadoEm  DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos (1-N)
  users        User[]
  leads        Lead[]
  subscription Subscription?             // (1-1) cada tenant tem no m√°ximo 1 assinatura

  @@map("tenants")
}

// =============================================================================
// MODELO: Subscription (Assinatura do Tenant)
// =============================================================================

/// Controla o estado financeiro/acesso do tenant ao SaaS.
/// Preparado para integra√ß√£o futura com o gateway Asaas.
/// Relacionamento: N-para-1 com Tenant (cada assinatura pertence a um tenant).
model Subscription {
  id                 String             @id @default(cuid())
  tenantId           String             @unique           // FK ‚Üí Tenant (1-1)
  status             SubscriptionStatus @default(ATIVA)
  dataVencimento     DateTime                             // Pr√≥xima data de cobran√ßa/vencimento
  linkPagamento      String?                              // URL de boleto/Pix gerado pelo Asaas
  asaasCustomerId    String?                              // ID do cliente no Asaas (integra√ß√£o externa)
  asaasSubscriptionId String?                             // ID da assinatura no Asaas
  criadoEm           DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  // Relacionamento (N-1)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

// =============================================================================
// MODELO: User (Utilizador)
// =============================================================================

/// Utilizador autenticado no sistema. Pertence a exatamente um Tenant,
/// exceto ADMIN_SAAS que pode operar sem tenant (tenantId nullable).
/// Relacionamentos:
///   N-para-1 com Tenant (um utilizador pertence a uma imobili√°ria)
///   1-para-N com Lead   (um corretor pode ser respons√°vel por v√°rios leads)
model User {
  id        String   @id @default(cuid())
  tenantId  String?                             // NULL apenas para ADMIN_SAAS
  nome      String
  email     String   @unique
  senha     String                              // Hash bcrypt ‚Äî nunca armazenar em texto simples
  role      UserRole @default(CORRETOR)
  ativo     Boolean  @default(true)             // Permite desativar conta sem apagar
  criadoEm DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamento N-1 com Tenant
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  // Relacionamento 1-N com Lead (leads sob responsabilidade deste corretor)
  leads Lead[]

  @@index([tenantId])
  @@map("users")
}

// =============================================================================
// MODELO: Lead (Entidade Principal)
// =============================================================================

/// Representa um potencial comprador/locat√°rio captado pela imobili√°ria.
/// √â a entidade central do CRM.
/// Relacionamentos:
///   N-para-1 com Tenant      (lead pertence a uma imobili√°ria)
///   N-para-1 com User        (lead tem um corretor respons√°vel)
///   1-para-N com LossReason  (quando VENDA_PERDIDA, regista o motivo)
///   1-para-N com LeadHistory (hist√≥rico de mudan√ßas de status)
model Lead {
  id          String     @id @default(cuid())
  tenantId    String                              // FK ‚Üí Tenant (isolamento multi-tenant)
  userId      String?                             // FK ‚Üí User (corretor respons√°vel; nullable = sem respons√°vel)
  nome        String
  telefone    String
  ddd         String                              // Ex.: "11", "21", "47" (max 3 chars)
  cidade      String
  interesse   String
  observacoes String?    @db.Text                 // üëà AQUI EST√Å O CAMPO NOVO!
  status      LeadStatus @default(NOVO_LEAD)
  isArquivado Boolean    @default(false)          // Soft-delete: true = lead arquivado/descartado
  criadoEm   DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  // Relacionamento N-1 com Tenant
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Relacionamento N-1 com User (corretor respons√°vel)
  corretor User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Relacionamento 1-N com LossReason (apenas quando status = VENDA_PERDIDA)
  lossReasons LossReason[]

  // Relacionamento 1-N com LeadHistory (auditoria de mudan√ßas de status)
  history LeadHistory[]

  @@index([tenantId])
  @@index([userId])
  @@index([status])
  @@index([tenantId, isArquivado]) // √çndice composto para queries de listagem filtrada
  @@map("leads")
}

// =============================================================================
// MODELO: LossReason (Motivo de Perda)
// =============================================================================

/// Registra a justificativa textual sempre que um lead passa para VENDA_PERDIDA.
/// Permite an√°lise futura dos motivos de perda de neg√≥cios.
/// Relacionamento: N-para-1 com Lead (um lead pode ter m√∫ltiplos registos
/// de perda se for reativado e perdido novamente).
model LossReason {
  id        String   @id @default(cuid())
  leadId    String                              // FK ‚Üí Lead
  motivo    String                              // Texto livre: ex. "Pre√ßo acima do or√ßamento"
  criadoEm DateTime @default(now())

  // Relacionamento N-1 com Lead
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@map("loss_reasons")
}

// =============================================================================
// MODELO: LeadHistory (Hist√≥rico / Auditoria de Status)
// =============================================================================

/// Regista cada transi√ß√£o de status de um lead, criando uma trilha de auditoria.
/// Permite visualizar o percurso completo do lead no funil.
/// Relacionamento: N-para-1 com Lead (um lead pode ter N transi√ß√µes).
model LeadHistory {
  id           String     @id @default(cuid())
  leadId       String                                // FK ‚Üí Lead
  statusAntes  LeadStatus                            // Status anterior √† mudan√ßa
  statusDepois LeadStatus                            // Novo status ap√≥s a mudan√ßa
  observacao   String?                               // Nota opcional do corretor sobre a transi√ß√£o
  criadoEm    DateTime   @default(now())

  // Relacionamento N-1 com Lead
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@map("lead_history")
}